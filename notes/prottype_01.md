# 卓球のプレー中のみを切り抜くアプリ開発
- プレー映像から必要な部分，つまりプレー中のみを抽出しプレー間のいらない時間をカットする

## Prottypse01
- 撮影する画角の固定
- 高画質撮影の想定
- 基本的なプレイスタイルを想定する

## タスク0:データ処理
- 動画の収集

## タスク1:動画の中でサービスする時間を抽出する
- oo分oo秒の地点でサービスの準備フォームに入ったことを特定する．
- まずは手前選手がサービスのフォームに入った瞬間を検出するようにする
- サービスの動き検出案
    - マストとして選手の姿勢検出は必須
    - 動き検出+時系列処理(動きの変化率的な処理)はサービス以外のご判定する可能性が高いと思う
    - 1. MediaPipeを使った姿勢検出+ルールベース判定
    - 2. 動き検出 + 時系列パターン分析
        - フレーム差分による動き検出に、時系列パターンを組み合わせます。
    - 3. オプティカルフロー解析
        - 画像全体の動きベクトルを解析して、サービス特有の動きパターンを検出します。
    - 4. YOLOv8などの物体検出 + トラッキング
        - 人物とラケット、ボールを検出してトラッキングします。
### 手前のプレイヤー選手に対する検出
- 卓球台の位置を検出する(基本的に固定されている)
- その卓球台に対してのプレイヤー検出の領域をあらかじめルールベース的に決めておくことで位置推定可能
## ニューラルネットワークモデルの必要性
- 動画映像などからサービスの瞬間を姿勢かつルールベースな処理で判定することは高難易度
- フォームの多様性，選手と背景画像の違いなどから基本的に難しい
## 動画の部分を認識する処理
1. 卓球台，手前選手，相手選手のトラッキング(背景の審判選手やコーチなどを追跡しない)
- YOLOv8/v11-Pose を使って、動画内の全人物を ID 付きでトラッキングし、その座標を ID ごとに CSV 保存するスクリプト
- 卓球台を検出してバウンディングボックスの出力
    - カスタムモデルで精度向上（推奨）
    - 卓球台のみを検出するカスタムYOLOモデルを学習
    - table_custom.pt として保存け
    - 追加作業: アノテーション + 学習

            1. 全体パイプライン：動画からハイライトへ
            システムは大きく4つのフェーズに分かれます。
            フェーズ①：環境認識と追跡（Input & Tracking）
            処理: YOLOv11-Poseで画面内の「人」と「骨格」を検出し、ByteTrackでIDを固定します。
            審判対策: 審判が重なって姿勢がロストしても、トラッカーがIDを保持し、カルマンフィルタが位置を予測し続けます。
            選別: 卓球台のバウンディングボックスに近い人物（手前の選手）のIDだけを抽出し、背景のノイズを除去します。
            フェーズ②：データの正規化（Preprocessing）
            処理: 抽出した座標データを、NNが理解しやすい形に変換します。
            正規化: 画面内の絶対座標ではなく、「腰の中心を原点(0,0)」とし、身体の大きさでスケーリングした相対座標に変換します。これにより、カメラの距離や解像度の違い（多様性）を吸収します。
            フェーズ③：時系列解析NN（NN Processing）
            処理: スライディングウィンドウ（例：過去30フレーム分）をGRUモデルに入力します。
            NNの役割: 単一の「絵」ではなく、関節がどう連動して動いたかという「時間の流れ（文脈）」を読み取ります。
            出力: 各ウィンドウに対して「サービス中である確率」を0.0〜1.0で算出します。
            フェーズ④：ポストプロセッシングとゴール（Output & Goal）
            処理: NNが出力した確率の波形を解析し、一定の閾値を超えた区間を「プレー中」と判定します。
            最終出力: * サービス開始・終了のタイムスタンプ。
            FFmpeg等を用いて自動で切り出された、プレー部分だけの動画ファイル。

            物体検出（YOLOv8/v11）: 1フレームごとに「人」と「卓球台」を検出
            トラッキング（ByteTrack）: 検出された「人」に一貫したIDを割り振ります
            姿勢推定（MediaPipe/YOLO-Pose）: 特定したID（手前の選手）のバウンディングボックス内だけで姿勢を推定
            座標変換: 卓球台の角を基準に、得られた関節座標を正規化
            NN推論（GRU/ST-GCN）: 正規化された時系列データをNNに流し込み、「サービス中」か判定

- 卓球台の姿勢，特に四角を検出する
    - 簡易化のために最初はユーザが卓球台の四角の座標をあらかじめ指定するものとする
- ホモグラフィ変換から卓球台の上からの座標に変更して選手のいる領域を検出する
- その領域から選手を追尾して姿勢を検出する
- 姿勢の時系列データからアノテーションした学習用データを作成してNNモデルの学習をしラリー中の時間を検出するモデルの作成をする．


sample01の卓球台の4角の座標
{
    "boxes": [
        {
            "id": "l",
            "label": "table",
            "x": "291.2374",
            "y": "156.0207",
            "width": "230.8745",
            "height": "48.4274",
            "keypoints": [
                {
                    "id": 0,
                    "x": "184.8551",
                    "y": "163.5938"
                },
                {
                    "id": 1,
                    "x": "331.4037",
                    "y": "164.8601"
                },
                {
                    "id": 2,
                    "x": "395.8707",
                    "y": "148.3543"
                },
                {
                    "id": 3,
                    "x": "288.4325",
                    "y": "148.5270"
                }
            ],
            "flipY": true
        }
    ],
    "height": 360,
    "key": "sample_video_01_01_frame_00000.jpg",
    "width": 640
}